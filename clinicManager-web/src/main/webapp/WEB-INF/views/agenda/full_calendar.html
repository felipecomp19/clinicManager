<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0"/>

<!-- Always force latest IE rendering engine or request Chrome Frame -->
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>

<!-- Use title if it's in the page YAML frontmatter -->
<title>Agenda</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,800" />
<link href="../../../resources/coreAdmin/stylesheets/application.css" rel="stylesheet" media="screen" th:href="@{/resources/coreAdmin/stylesheets/application.css}" type="text/css" />
<link href="../../../resources/fullcalendar/fullcalendar.css" rel="stylesheet" media="screen" th:href="@{/resources/fullcalendar/fullcalendar.css}" type="text/css" />

</head>

<body>
	<!-- header -->
	<div th:replace="fragments/header :: header">&nbsp;</div>
	
	<!-- side bar -->
	<div th:replace="fragments/sidebar :: sidebar">&nbsp;</div>
		
	<div class="main-content">
	
		<!-- top main content -->
		<div th:replace="fragments/mainContent :: mainContent(title_mainContent=#{label.agenda}, subTitle_mainContent=#{label.agenda}, icon='icon-calendar')">&nbsp;</div>
	
		<div class="container padded">
			<div class="row">
				<!-- Breadcrumb line -->
				<div id="breadcrumbs">
					<div class="breadcrumb-button blue">
						<span class="breadcrumb-label"><i class="icon-home"></i>Home</span> <span class="breadcrumb-arrow"><span></span></span>
					</div>
					<div class="breadcrumb-button">
						<span class="breadcrumb-label"><i class="icon-calendar"></i>
							<span th:text="#{label.fullCalendar}">Agenda completa</span>
						</span> 
						<span class="breadcrumb-arrow"><span></span></span>
					</div>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div class="col-md-3" id='external-events'>
					<div class="box">
						<div class="box-header">
							<span class="title" th:text="#{label.pacientes}">Paciente</span>
						</div>
						<div class="box-content">
							<div id="external-events" class="nav-menu" style="padding: 10px;">
								<ul class="nav nav-list">
									<li th:each="p : ${consultaForm.dataEvents}" style="margin: 5px;">
										<a class='fc-event' th:text="${p.name}" th:attr="patientId=${p.id}">Patient Name</a>
									</li>
									<li class="hidden-option">
										<a id="add-event" class="flat" href="#">
											<i class="icon-plus"></i><span th:text="#{label.newPatient}">New patient</span>
										</a>
									</li>
									<li style="padding: 10px">
										<div class="clearfix">
											<div class="pull-left">remove after drop</div>
											<div class="pull-right" style="margin-right: 2px;">
												<input type='checkbox' id='drop-remove' class="checky" /> <label
													for='drop-remove' class="checky"><span></span></label>
											</div>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-9">
					<div class="box">
						<div class="box-header">
							<span class="title" th:text="#{label.fullCalendar}">Full calendar</span>
						</div>
						<div class="box-content">
							<div id="myCalendar" th:attr="consultas=${consultas}"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


<script src="../../../resources/fullcalendar/lib/moment.min.js" th:src="@{/resources/fullcalendar/lib/moment.min.js}" type="text/javascript"></script>
<script src="../../../resources/fullcalendar/lib/jquery.min.js" th:src="@{/resources/fullcalendar/lib/jquery.min.js}" type="text/javascript"></script>
<script src="../../../resources/fullcalendar/lib/jquery-ui.custom.min.js" th:src="@{/resources/fullcalendar/lib/jquery-ui.custom.min.js}" type="text/javascript"></script>

<script src="../../../resources/fullcalendar/fullcalendar.min.js" th:src="@{/resources/fullcalendar/fullcalendar.min.js}" type="text/javascript"></script>
<script src="../../../resources/fullcalendar/lang-all.js" th:src="@{/resources/fullcalendar/lang-all.js}" type="text/javascript"></script>

<script src="../../../resources/coreAdmin/javascripts/gritter.js" th:src="@{/resources/coreAdmin/javascripts/gritter.js}" type="text/javascript"></script>
<script src="../../../resources/coreAdmin/javascripts/vendor/jquery_gritter.js" th:src="@{/resources/coreAdmin/javascripts/vendor/jquery_gritter.js}" type="text/javascript"></script>

<script type="text/javascript">
     
$(document).ready(function() {

var currentLangCode = 'pt-br';

function createConsulta(event) {
	var consultaJson = "{\"patientId\":\"" + event.patientId + "\",\"dataDaConsulta\":\"" + event.start + "\",\"dataFimDaConsulta\":\"" + event.end + "\"}";
	$.ajax({
		url : "/agenda/consulta/create",
		type : 'POST',
		dataType : 'json',
		data : consultaJson,
		contentType : 'application/json',
		mimeType : 'application/json',
		success : function(consulta) {
			event.consultaId = consulta.id;
			return Growl.success({
		 			title:'Sucesso!',
		 			text:'Consulta cadastrada com sucesso.'
	 		});
		},
		error : function(data, status, er) {
			return Growl.error({
	 			title:'Erro!',
	 			text:'Consulta n√£o cadastrada.'
 			});
		}
	});
}

function updateConsulta(event) {
	var consultaJson = "{\"id\":\"" + event.consultaId + "\", \"patientId\":\"" + event.patientId + "\",\"dataDaConsulta\":\"" + event.start + "\",\"dataFimDaConsulta\":\"" + event.end + "\"}";
	$.ajax({
		url : "/agenda/consulta/update",
		type : 'POST',
		dataType : 'json',
		data : consultaJson,
		contentType : 'application/json',
		mimeType : 'application/json',
		success : function(consulta) {
			return Growl.success({
		 			title:'Sucesso!',
		 			text:'Consulta atualizada com sucesso.'
	 		});
		},
		error : function(data, status, er) {
			return Growl.error({
	 			title:'Erro!',
	 			text:'Falha ao atualizar a consulta.'
 			});
		}
	});
}

/* initialize the external events
-----------------------------------------------------------------*/
$('#external-events .fc-event').each(function() {
	// store data so the calendar knows to render an event upon drop
	$(this).data('event', {
		patientId: $(this).attr("patientId"),
		consultaId: 0,
		title: $(this).text(), // use the element's text as the event title
		duration: "01:00",
		stick: true // maintain when user navigates (see docs on the renderEvent method)
	});

	// make the event draggable using jQuery UI
	$(this).draggable({
		zIndex: 999,
		revert: true,      // will cause the event to go back to its
		revertDuration: 0  //  original position after the drag
	});

});

$('#myCalendar').fullCalendar(
	{
		height : 700,
		header : {
			left : 'prev,next today',
			center : 'title',
			right : 'month,agendaWeek,agendaDay'
		},
		lang : currentLangCode,
		defaultView : 'agendaWeek',
		allDaySlot : false,
		scrollTime : '08:00:00',
		droppable : true,
		drop : function(date) {
			if ($("#drop-remove").is(":checked")) {
				return $(this).remove();
			}
		},
		eventReceive : function(event) {
			console.log(event.start.format('YYYY-MM-DD HH:mm'))
			createConsulta(event);
		},
		editable : true,
		eventClick : function(calEvent, jsEvent, view) {
			alert('Event: ' + calEvent.title + " : " + calEvent.id + " : " + calEvent.start.format('YYYY-MM-DD HH:mm') + " : " + calEvent.end);

			// change the border color just for fun
			$(this).css('border-color','red');
		},
		eventDrop : function(event, delta, revertFunc) {
			console.log(event.start.format('YYYY-MM-DD HH:mm'))
			updateConsulta(event);
		},
		eventResize: function(event, delta, revertFunc) {
			updateConsulta(event);
	    },
	    events: {
	    	url: '/agenda/consulta/list',
	    }
	});
});
</script>
</body>
</html>
